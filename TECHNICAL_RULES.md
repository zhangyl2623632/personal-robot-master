# 个人智能问答机器人技术规范

## 1. 项目概述

个人智能问答机器人是一个基于RAG（检索增强生成）技术的智能问答系统，能够处理本地文档并提供基于文档内容的智能问答服务。

## 2. 技术栈

### 2.1 核心语言
- Python 3.10+

### 2.2 主要框架和库
- **Web框架**: Flask
- **RAG组件**: LangChain
- **向量存储**: Chroma
- **文档处理**: PyPDFLoader, UnstructuredWordDocumentLoader, etc.
- **嵌入模型**: SentenceTransformer (all-MiniLM-L6-v2)
- **LLM集成**: DeepSeek API

## 3. 目录结构

```
personal-robot-master/
├── .env                    # 环境变量配置
├── README.md               # 项目说明文档
├── requirements.txt        # 项目依赖
├── src/                    # 源代码目录
│   ├── config.py           # 配置管理
│   ├── document_loader.py  # 文档加载和处理
│   ├── document_monitor.py # 文档监控功能
│   ├── llm_client.py       # LLM客户端
│   ├── rag_pipeline.py     # RAG处理流水线
│   ├── vector_store.py     # 向量存储管理
│   ├── web_interface.py    # Web接口
│   └── main.py             # 命令行入口
├── data/                   # 文档存储目录
├── vector_store/           # 向量存储数据
├── static/                 # 静态资源
│   ├── script.js           # JavaScript代码
│   └── style.css           # CSS样式
├── templates/              # HTML模板
│   └── index.html          # 主页面模板
└── start_web.bat           # Web服务启动脚本
```

## 4. 代码规范

### 4.1 命名规范
- 类名: 使用大驼峰命名法 (如 `DocumentLoader`)
- 函数/方法名: 使用小驼峰命名法 (如 `load_document`)
- 变量名: 使用小驼峰命名法或下划线分隔法 (如 `file_path` 或 `vector_store`)
- 常量: 使用全大写字母加下划线分隔 (如 `MAX_TOKENS`)

### 4.2 代码风格
- 每行代码不超过100个字符
- 使用4个空格进行缩进（不使用Tab）
- 类和函数之间使用两个空行分隔
- 函数内部逻辑块之间使用一个空行分隔

### 4.3 文档注释
- 每个类和函数都必须包含文档字符串（docstring）
- 文档字符串应描述功能、参数、返回值和异常情况
- 关键逻辑添加单行注释说明

## 5. 配置管理

### 5.1 配置文件
- 所有配置集中在 `src/config.py` 文件中
- 使用 `Config` 类统一管理配置项
- 通过环境变量覆盖默认配置

### 5.2 环境变量
- 使用 `.env` 文件存储敏感信息（如API密钥）
- 环境变量命名规范: 项目前缀大写字母加下划线（如 `DEEPSEEK_API_KEY`）

## 6. 文档处理流程

### 6.1 支持的文件类型
- 文本文件: `.txt`, `.md`
- 办公文档: `.pdf`, `.docx`, `.xlsx`, `.csv`
- 图片文件: `.jpg`, `.jpeg`, `.png`, `.gif` (使用OCR处理)

### 6.2 文档加载流程
1. 通过 `DocumentLoader` 类加载不同类型的文档
2. 对文档进行分割处理（默认块大小: 1000字符，重叠: 200字符）
3. 将分割后的文档块转换为向量并存储到Chroma向量数据库

### 6.3 文档监控
- 通过 `DocumentMonitor` 类定时监控 `data` 目录的变化
- 监控间隔可通过配置 `DOCUMENT_UPDATE_INTERVAL` 设置（默认300秒）
- 自动检测新文件、修改的文件并更新向量存储

## 7. 向量存储规范

### 7.1 向量存储初始化
- 使用 `VectorStoreManager` 类管理向量存储
- 支持自动初始化和重建向量存储

### 7.2 向量操作
- 添加文档: 使用 `add_documents` 方法
- 相似度搜索: 使用 `similarity_search` 方法
- 清空向量存储: 使用 `clear_vector_store` 方法
- 获取向量数量: 使用 `get_vector_count` 方法

### 7.3 嵌入模型
- 优先使用配置的嵌入模型
- 失败时自动回退到本地 `SimpleWordFrequencyEmbeddings` 模型

## 8. API接口规范

### 8.1 Web接口
- 基础URL: `/`
- 静态文件: `/static/`
- API端点: `/api/`

### 8.2 主要API端点
- POST `/api/chat`: 提交问题获取回答
- POST `/api/upload`: 上传文档
- GET `/api/status`: 获取系统状态

### 8.3 请求和响应格式
- 使用JSON格式进行数据交换
- 响应包含 `success` 状态和 `message` 信息
- 错误情况返回相应的HTTP状态码和错误信息

## 9. 部署指南

### 9.1 开发环境
- 安装依赖: `pip install -r requirements.txt`
- 启动Web服务: `python -m src.web_interface` 或运行 `start_web.bat`

### 9.2 生产环境注意事项
- 禁止使用开发服务器部署到生产环境
- 使用WSGI服务器（如Gunicorn）部署
- 配置合适的进程数和线程数
- 设置适当的文件访问权限

## 10. 开发工作流

### 10.1 代码提交
- 保持提交粒度小而集中
- 提交信息清晰描述更改内容
- 避免提交敏感信息和生成的文件

### 10.2 测试规范
- 为核心功能编写单元测试
- 测试文档处理和向量存储功能
- 验证不同类型文档的兼容性

### 10.3 日志管理
- 使用Python标准logging模块
- 日志级别分为DEBUG、INFO、WARNING、ERROR
- 关键操作和错误情况必须记录日志

## 11. 安全规范

### 11.1 文件上传安全
- 使用 `secure_filename` 函数处理文件名
- 限制允许上传的文件类型
- 设置适当的文件大小限制

### 11.2 数据安全
- 敏感信息（如API密钥）不直接硬编码在代码中
- 使用环境变量或配置文件存储敏感信息
- 定期清理临时文件

### 11.3 API安全
- 实现请求验证和限流
- 防止SQL注入和XSS攻击
- 对敏感数据进行加密处理

## 12. 性能优化

### 12.1 文档处理优化
- 大文件分割处理
- 批量添加向量
- 使用异步处理提高性能

### 12.2 向量搜索优化
- 调整搜索参数（如k值）平衡精度和性能
- 定期维护向量存储
- 适当调整文档块大小和重叠度

## 13. 故障排查

### 13.1 常见问题及解决方案
- 文档加载失败: 检查文件格式和权限
- 向量存储错误: 尝试重建向量存储
- API调用失败: 检查网络连接和API密钥

### 13.2 日志分析
- 分析系统日志定位问题
- 重点关注ERROR级别日志
- 根据错误信息查找相应的代码位置

## 14. 文档与版本管理

### 14.1 README更新规范
- 每次对项目功能、结构、配置或使用方法进行改动时，必须同步更新README.md文件
- README更新应包含：
  - 新增功能的详细说明
  - 修改的功能点及变更内容
  - 配置项的增减或修改
  - 使用方法的变更
- 更新后的README.md应确保内容准确、清晰，与实际代码行为一致

### 14.2 版本自动更新规范
- 项目采用语义化版本号（Major.Minor.Patch）管理
- 每次代码提交或功能发布时，系统应自动更新版本号：
  - 重大功能变更或架构调整，增加Major版本号
  - 新增功能但向下兼容，增加Minor版本号
  - 修复bug但不影响现有功能，增加Patch版本号
- 版本号应在README.md文件中清晰标注
- 重要版本更新应记录更新日志，说明主要变更内容

---

*最后更新时间: 2024-09-15*